<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tonnel</title>
  <style>
    :root{
      --bg1:#070A1A; --bg2:#0B1235;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.08);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.55);
      --stroke:rgba(255,255,255,.10);
      --glow:rgba(120,120,255,.22);
      --glow2:rgba(90,255,200,.14);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1000px 600px at 25% 15%, var(--glow), transparent 60%),
        radial-gradient(900px 500px at 80% 30%, var(--glow2), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      min-height:100vh;
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px 16px 92px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 14px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg,var(--panel2),var(--panel));
      border-radius:var(--r);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 40px rgba(0,0,0,.25);
    }
    .brand{font-weight:800; letter-spacing:.3px}
    .pill{
      padding:8px 10px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background:rgba(255,255,255,.05);
      color:var(--muted);
      font-size:12px;
    }
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:12px;
    }
    .tab{
      padding:10px 12px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background:rgba(255,255,255,.04);
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      font-size:13px;
    }
    .tab.active{
      background:rgba(255,255,255,.10);
      color:var(--txt);
      border-color:rgba(255,255,255,.18);
    }
    .panel{
      margin-top:14px;
      border:1px solid var(--stroke);
      border-radius:var(--r);
      background:linear-gradient(180deg,var(--panel2),var(--panel));
      padding:14px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 40px rgba(0,0,0,.25);
    }
    .muted{color:var(--muted)}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .title{font-weight:800; font-size:16px}
    .btn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .nav{
      position:fixed; left:0; right:0; bottom:0;
      padding:10px 10px;
      background:rgba(0,0,0,.30);
      backdrop-filter: blur(14px);
      border-top:1px solid rgba(255,255,255,.10);
    }
    .navinner{
      max-width:980px;margin:0 auto;
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:8px;
    }
    .navbtn{
      padding:10px 8px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      text-align:center;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .navbtn.active{
      background:rgba(255,255,255,.10);
      color:var(--txt);
      border-color:rgba(255,255,255,.20);
    }
    .item{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      border-radius:16px;
      padding:12px;
      margin-top:10px;
    }
    .item .meta{font-size:12px; color:var(--muted); margin-top:6px}
    code{color:rgba(255,255,255,.75)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">Tonnel</div>
      <div class="pill" id="userPill">user: —</div>
    </div>

    <div class="tabs" id="topTabs">
      <div class="tab active" data-tab="gifts">Gifts</div>
      <div class="tab" data-tab="activity">Activity</div>
      <div class="tab" data-tab="orders">Orders</div>
      <div class="tab" data-tab="deals">Deals</div>
      <div class="tab" data-tab="offers">Offers</div>
    </div>

    <div class="panel" id="content">
      <!-- dynamic -->
    </div>
  </div>

  <div class="nav">
    <div class="navinner" id="bottomNav">
      <div class="navbtn" data-nav="market">Market</div>
      <div class="navbtn" data-nav="auctions">Auctions</div>
      <div class="navbtn" data-nav="lease">Lease</div>
      <div class="navbtn active" data-nav="mygifts">My Gifts</div>
      <div class="navbtn" data-nav="gallery">Gallery</div>
      <div class="navbtn" data-nav="activity">Activity</div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    // Локально (ПК): работает сразу
    const API_BASE = "http://127.0.0.1:8000";

    const state = {
      bottom: "mygifts",
      top: "gifts",
      telegramId: null,
      inventory: [],
      invCount: 0,
    };

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function getTelegramId() {
      // Telegram WebApp
      try {
        const id = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
        if (id) return id;
      } catch (_) {}

      // Debug in browser
      const saved = localStorage.getItem("tonnel_debug_tid");
      if (saved) return parseInt(saved, 10);

      const v = prompt("Enter telegram_id for debug (saved):");
      if (v) {
        localStorage.setItem("tonnel_debug_tid", v);
        return parseInt(v, 10);
      }
      return null;
    }

    async function apiGet(path) {
      const r = await fetch(API_BASE + path);
      if (!r.ok) throw new Error(`API ${path} failed: ${r.status}`);
      return r.json();
    }

    function fmtDate(s) {
      if (!s) return "";
      return String(s).replace("T", " ").slice(0, 19);
    }

    function setActiveButtons() {
      $$("#bottomNav .navbtn").forEach(b => b.classList.toggle("active", b.dataset.nav === state.bottom));
      $$("#topTabs .tab").forEach(t => t.classList.toggle("active", t.dataset.tab === state.top));
    }

    function render() {
      const c = $("#content");
      setActiveButtons();

      if (state.bottom === "mygifts") {
        c.innerHTML = `
          <div class="row">
            <div>
              <div class="title">My Gifts</div>
              <div class="muted">Stored on vault account • showing deposits linked to your Telegram ID</div>
            </div>
            <button class="btn" id="btnSync">Sync</button>
          </div>

          <div class="item" style="margin-top:12px;">
            <div class="muted">telegram_id: <code>${state.telegramId ?? "—"}</code></div>
            <div class="muted">items: <code>${state.invCount}</code></div>
          </div>

          <div id="myGiftsList"></div>
        `;

        $("#btnSync").addEventListener("click", () => loadInventory(true));

        const list = $("#myGiftsList");
        if (!state.inventory.length) {
          list.innerHTML = `<div class="item"><div class="muted">No items yet. Send an NFT/gift to the storage account.</div></div>`;
        } else {
          list.innerHTML = state.inventory.map(it => `
            <div class="item">
              <div class="row">
                <div style="font-weight:800;">Stored item #${it.id}</div>
                <div class="muted" style="font-size:12px;">${fmtDate(it.created_at)}</div>
              </div>
              <div class="meta">state: <b>${it.state}</b> • ref: ${it.storage_ref}</div>
            </div>
          `).join("");
        }
        return;
      }

      // остальные вкладки пока заглушки
      c.innerHTML = `
        <div class="title">${state.bottom}</div>
        <div class="muted">Coming soon</div>
      `;
    }

    async function loadInventory(forceRender=false) {
      if (!state.telegramId) return;
      try {
        const data = await apiGet(`/inventory/${state.telegramId}`);
        state.inventory = data.items || [];
        state.invCount = data.count || 0;
        if (forceRender || state.bottom === "mygifts") render();
      } catch (e) {
        console.error(e);
        if (state.bottom === "mygifts") {
          $("#content").innerHTML = `<div class="title">My Gifts</div><div class="muted">API error: ${String(e.message || e)}</div>`;
        }
      }
    }

    function initUI() {
      state.telegramId = getTelegramId();
      $("#userPill").textContent = `user: ${state.telegramId ?? "—"}`;

      $$("#bottomNav .navbtn").forEach(b => {
        b.addEventListener("click", () => {
          state.bottom = b.dataset.nav;
          render();
          if (state.bottom === "mygifts") loadInventory(true);
        });
      });

      $$("#topTabs .tab").forEach(t => {
        t.addEventListener("click", () => {
          state.top = t.dataset.tab;
          render();
        });
      });

      try { window.Telegram?.WebApp?.ready?.(); } catch(_) {}
      render();
      loadInventory(false);
    }

    window.addEventListener("load", initUI);
  </script>
</body>
</html>
